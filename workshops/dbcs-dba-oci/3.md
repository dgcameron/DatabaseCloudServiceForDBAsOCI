# Tablespace, Schema and Table Migration Use Cases

## Introduction

This is the third of five labs that are part of the Oracle Public Cloud Database Cloud Service workshop. 

In this lab, you will explore some common use cases for moving sub-sets of your data from on-premises to the cloud. There are multiple options for solving this data movement challenge. In this lab, we will migrate databases, tablespaces, schemas, and individual tables. You will be migrating data from the source database to the target database, and will use standard Oracle Data Pump tools to perform these migrations.   These are only a few of the many options for moving data into and between Oracle databases.  More choices for how to migrate Oracle Databases from on-premise to the cloud can be found in this [Migration Strategies Document](http://www.oracle.com/technetwork/database/database-appliance/documentation/oda-migration-strategies-1676870.pdf).

***Note: All the steps in this lab will be done using ssh, bash commands, and sqlplus.***

This lab supports the following use cases:
-	Migration of tablespaces using physical file copy.
-	Logical migration of databases and data schemas using data pump.
-	Use of database links to selectively copy tables from source to target.

To log issues and view the Lab Guide source, go to the [github oracle](https://github.com/oracle/learning-library/tree/master/workshops/dbcs-dba-oci) repository.

## Objectives

-   Hot clone a pluggable database from on-premise to the Cloud.
-   Migrate a schema using Oracle Data Pump.
-   Migrate data using a Transportable Tablespace.
-   Copy data using Database Links.

## Required Artifacts

-   You must have successfully completed lab 1.  Completion of lab 2 is not required.

## **Step 1 Tablespace Migration:**  Create a new alpha_archive schema and tablespace that will be migrated to the target database.

While datapump provides a very fast multi-threaded technique to move data quickly between Oracle Databases, it was not designed for very large volumes of data. Transportable Tablespaces enable a database file copy technique that does not require an exported copy of the data, but instead allow you to copy the in-place data files to target, which using Datapump to capture the metadata only. 

- SSH into the source `workshop1_db` database and create the user and tablespace `alpha_archive`.
```
sudo su - oracle
sqlplus system/<password>@pdb1;
create tablespace alpha_archive datafile '+data';
create user alpha_archive identified by <password> default tablespace alpha_archive;
grant dba to alpha_archive;
-- copy and paste this:
begin
for i in (select table_name from all_tables where owner = 'ALPHA')
loop
execute immediate 'create table alpha_archive.'||i.table_name||' as select * from alpha.'||i.table_name;
end loop;
end;
/
-- end copy/paste
```

- Confirm the user, tablespace, and data was created correctly.
```
connect alpha_archive/<password>@pdb1;
col table_name format a30
col tablespace_name format a30
set pagesize 0
select table_name, tablespace_name from user_tables;

SQL> /
ADDRESSES		       	ALPHA_ARCHIVE
ADDRESS_USAGES		     ALPHA_ARCHIVE
ALPHA_SERVICES_STATS	ALPHA_ARCHIVE
COUNTRY_CODES		     ALPHA_ARCHIVE
COUPON_USAGES		     ALPHA_ARCHIVE
CUSTOMERS		       	ALPHA_ARCHIVE
CUSTOMER_IDENTIFICATIONS ALPHA_ARCHIVE
CUSTOMER_INTERESTS	     ALPHA_ARCHIVE
DISCOUNTS		          ALPHA_ARCHIVE
LOOKUP_CODES		     ALPHA_ARCHIVE
ORDERS			     ALPHA_ARCHIVE
ORDER_ITEMS		     ALPHA_ARCHIVE
PAYMENT_OPTIONS 	     ALPHA_ARCHIVE
PRODUCTS		          ALPHA_ARCHIVE
PRODUCT_CATEGORIES	     ALPHA_ARCHIVE
PRODUCT_IMAGES		     ALPHA_ARCHIVE
PRODUCT_STOCK_LEVELS	ALPHA_ARCHIVE
SALES_ORDER_HEADER	     ALPHA_ARCHIVE
SALES_ORDER_LINE_ITEM	ALPHA_ARCHIVE
```

- Set the tablespace to be migrated in read only.
```
alter tablespace alpha_archive read only;
Tablespace altered.
```

- Export the `alpha_archive` metadata.
```
create directory tmp as '/tmp';
grant all on directory tmp to public;

exit -- from sqlplus

expdp system/<password>@pdb1 directory=tmp dumpfile=alpha_archive_tbs.dmp transport_tablespaces=alpha_archive exclude=statistics encryption_password=<password> logfile=full_tts_export.log

[oracle@workshop1 tmp]$ expdp system/<password>@pdb1 directory=tmp dumpfile=alpha_archive_tbs.dmp transport_tablespaces=alpha_archive exclude=statistics encryption_password=<password> logfile=full_tts_export.log

Export: Release 19.0.0.0.0 - Production on Wed Jan 29 22:30:01 2020
Version 19.5.0.0.0

Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.

Connected to: Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Starting "SYSTEM"."SYS_EXPORT_TRANSPORTABLE_01":  system/********@pdb1 directory=tmp dumpfile=alpha_archive_tbs.dmp transport_tablespaces=alpha_archive exclude=statistics encryption_password=******** logfile=full_tts_export.log 
Processing object type TRANSPORTABLE_EXPORT/PLUGTS_BLK
Processing object type TRANSPORTABLE_EXPORT/POST_INSTANCE/PLUGTS_BLK
Processing object type TRANSPORTABLE_EXPORT/TABLE
Master table "SYSTEM"."SYS_EXPORT_TRANSPORTABLE_01" successfully loaded/unloaded
******************************************************************************
Dump file set for SYSTEM.SYS_EXPORT_TRANSPORTABLE_01 is:
  /tmp/alpha_archive_tbs.dmp
******************************************************************************
Datafiles required for transportable tablespace ALPHA_ARCHIVE:
  +DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive.276.1031003683
Job "SYSTEM"."SYS_EXPORT_TRANSPORTABLE_01" successfully completed at Wed Jan 29 22:30:47 2020 elapsed 0 00:00:44
```

- Change the permissions on the export file so user opc can copy to the target database.
```
chmod a+r /tmp/alpha_archive_tbs.dmp

exit -- from user oracle
```

- Copy the metadata (dmp file) to the target database using the opc user.
```
scp -i ~/privateKey /tmp/alpha_archive_tbs.dmp opc@129.146.123.48:/tmp
[opc@workshop1 ~]$ scp -i ~/privateKey /tmp/alpha_archive_tbs.dmp opc@129.146.123.48:/tmp
alpha_archive_tbs.dmp                         100%  652KB  67.9MB/s   00:00 
```

- At this point we have only exported the metadata (table definitions - not the data itself).  Next locate and review the `alpha_archive` datafiles.
```
sudo su - oracle
sqlplus system/<password>@pdb1
set linesize 100
col tablespace_name format a15
col file_name format a60
select tablespace_name, file_name from dba_data_files;

TABLESPACE_NAME FILE_NAME
--------------- ------------------------------------------------------------
SYSTEM	 	+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/system.271.1029871741
SYSAUX	 	+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/sysaux.272.1029871741
UNDOTBS1	+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/undotbs1.270.1029871741
USERS		+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/users.275.1029872131
ALPHA_ARCHIVE	+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive.276.1031003683

exit -- from sqlplus
```

- Now we know where the data files are in Automatic Storage Management (ASM) we need to use `asmcmd` to copy the data out of the file manager to tmp before copying to the target database.  ***Note: your file names will be different - take note and use those names/versions***.
```
asmcmd -a sysdba
cp +DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive.276.1031003683 /tmp
copying +DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive.276.1031003683 -> /tmp/alpha_archive.276.1031003683

exit -- out of asmcmd
exit -- out of oracle
```

- Now we have the data copied to tmp we need to copy it to the target database.  First change the permissions so opc user can read the data, and then scp/copy the data.
```
sudo chmod a+r /tmp/alpha_archive.276.1031003683

scp -i ~/privateKey /tmp/alpha_archive.276.1031003683 opc@129.146.123.48:/tmp
alpha_archive.276.1031003683                              100%  100MB  94.0MB/s   00:01    

exit -- out of workshop1_db
```

- All of the above was done on the source database VM.  The remainder will be done on the target database.  SSH into the target database VM and change file permissions so user oracle can import/copy the data and metadata. 
```
sudo chown oracle /tmp/alpha*
```

- Review the data files.  Since in lab 2 you cloned the source database the ASM files will be exactly the same.  Normally they would not be, and you would need to review the files to identify the directories to where you will copy the data files.
```
sudo su - oracle
sqlplus system/<password>@pdb1
set linesize 100
col tablespace_name format a15
col file_name format a60
select tablespace_name, file_name from dba_data_files;

TABLESPACE_NAME FILE_NAME
--------------- ------------------------------------------------------------
SYSTEM		+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/system.271.1029871741
SYSAUX		+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/sysaux.272.1029871741
UNDOTBS1	+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/undotbs1.270.1029871741
USERS		+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/users.275.1029872131

exit -- from sqlplus
```

- Next copy the data file to the target ASM directory.  Again use asmcmd to do that.
```
asmcmd -a sysdba
cp /tmp/alpha_archive.276.1031003683 +DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive
copying /tmp/alpha_archive.276.1031003683 -> +DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive
```

- Review/confirm the file was copied.
```
ls +DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE
ASMCMD> ls +DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE
SYSAUX.272.1029871741
SYSTEM.271.1029871741
UNDOTBS1.270.1029871741
USERS.275.1029872131
alpha_archive

exit -- from asmcmd
```

- Now create user alpha_archive and directory tmp.
```
sqlplus system/<password>@pdb1

create user alpha_archive identified by <password>;
User created.
grant dba to alpha_archive;
Grant succeeded.
create directory tmp as '/tmp'; -- this may already exist

exit -- from sqlplus
```

- Now import the metadata (table definitions).
```
impdp system/<password>@pdb1 directory=tmp dumpfile=alpha_archive_tbs.dmp logfile=full_tts_imp.log encryption_password=<password> transport_datafiles=+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive

[oracle@workshop1 ~]$ impdp system/<password>@pdb1 directory=tmp dumpfile=alpha_archive_tbs.dmp logfile=full_tts_imp.log encryption_password=<password> transport_datafiles=+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive

Import: Release 19.0.0.0.0 - Production on Wed Jan 29 23:27:37 2020
Version 19.5.0.0.0

Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.

Connected to: Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Master table "SYSTEM"."SYS_IMPORT_TRANSPORTABLE_01" successfully loaded/unloaded
Starting "SYSTEM"."SYS_IMPORT_TRANSPORTABLE_01":  system/********@pdb1 directory=tmp dumpfile=alpha_archive_tbs.dmp logfile=full_tts_imp.log encryption_password=******** transport_datafiles=+DATA/ORCL_PHX273/9C47D64835F00F3BE0530700000A3085/DATAFILE/alpha_archive 
Processing object type TRANSPORTABLE_EXPORT/PLUGTS_BLK
Processing object type TRANSPORTABLE_EXPORT/TABLE
Processing object type TRANSPORTABLE_EXPORT/POST_INSTANCE/PLUGTS_BLK
Job "SYSTEM"."SYS_IMPORT_TRANSPORTABLE_01" successfully completed at Wed Jan 29 23:27:55 2020 elapsed 0 00:00:17
```

- Log into user `alpha_archive` and confirm the data was migrated successfully.
```
sqlplus alpha_archive/<password>@pdb1

SQL*Plus: Release 19.0.0.0.0 - Production on Wed Jan 29 23:28:46 2020
Version 19.5.0.0.0

Copyright (c) 1982, 2019, Oracle.  All rights reserved.

Connected to:
Oracle Database 19c EE High Perf Release 19.0.0.0.0 - Production
Version 19.5.0.0.0

select table_name from user_tables;

TABLE_NAME
--------------------------------------------------------------------------------
PRODUCT_STOCK_LEVELS
DISCOUNTS
ALPHA_SERVICES_STATS
ADDRESS_USAGES
COUNTRY_CODES
ORDER_ITEMS
PRODUCTS
ORDERS
CUSTOMER_IDENTIFICATIONS
CUSTOMER_INTERESTS
PAYMENT_OPTIONS
SALES_ORDER_HEADER
LOOKUP_CODES
ADDRESSES
CUSTOMERS
PRODUCT_CATEGORIES
COUPON_USAGES
SALES_ORDER_LINE_ITEM
PRODUCT_IMAGES

19 rows selected.
```

## ** Step 2 Data Pump Migration:**  Migrate data in a pdb using data pump.


